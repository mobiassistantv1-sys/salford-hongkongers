<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Áæ©Â∑•Á∞ΩÂà∞ | Salford Hongkongers</title>
<style>
:root {
  --pink: #ff2d78;
  --blue: #00d4ff;
  --purple: #b44fff;
  --green-neon: #39ff14;
  --bg: #0a0a0f;
  --card-bg: rgba(255,255,255,0.05);
  --card-border: rgba(255,255,255,0.1);
  --text: #f0f0f0;
  --text-muted: rgba(255,255,255,0.45);
  --radius: 16px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Segoe UI', system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  background-image:
    radial-gradient(ellipse at 20% 20%, rgba(255,45,120,0.08) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 80%, rgba(0,212,255,0.08) 0%, transparent 50%);
}

/* NAV */
nav {
  background: rgba(10,10,15,0.95);
  border-bottom: 1px solid rgba(255,45,120,0.3);
  padding: 14px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
  backdrop-filter: blur(12px);
  position: sticky; top: 0; z-index: 100;
}
nav .logo {
  color: #fff;
  font-size: 1rem;
  font-weight: 800;
  letter-spacing: -0.3px;
}
nav .logo span {
  color: var(--pink);
  text-shadow: 0 0 10px var(--pink);
}
nav .nav-time {
  color: var(--blue);
  font-size: 0.88rem;
  font-variant-numeric: tabular-nums;
  font-weight: 700;
  text-shadow: 0 0 8px var(--blue);
}
nav .back-btn {
  color: var(--text-muted);
  font-size: 0.85rem;
  text-decoration: none;
  display: flex; align-items: center; gap: 4px;
  transition: color 0.2s;
}
nav .back-btn:hover { color: var(--pink); }

/* LAYOUT */
.page {
  display: flex; flex-direction: column; gap: 16px;
  padding: 20px 16px 40px;
  max-width: 560px; margin: 0 auto; width: 100%;
}

/* CLOCK HERO */
.clock-hero {
  background: linear-gradient(135deg, rgba(255,45,120,0.15), rgba(0,212,255,0.1));
  border: 1px solid rgba(255,45,120,0.3);
  border-radius: var(--radius);
  padding: 28px 20px 22px;
  text-align: center;
  position: relative;
  overflow: hidden;
  box-shadow: 0 0 30px rgba(255,45,120,0.15), inset 0 1px 0 rgba(255,255,255,0.1);
}
.clock-hero::before {
  content: '';
  position: absolute; inset: 0;
  background: linear-gradient(180deg, rgba(255,255,255,0.03) 0%, transparent 100%);
  pointer-events: none;
}
.clock-display {
  font-size: 3.4rem; font-weight: 800;
  letter-spacing: 6px; font-variant-numeric: tabular-nums;
  line-height: 1; margin-bottom: 8px;
  color: #fff;
  text-shadow: 0 0 20px rgba(255,45,120,0.8), 0 0 40px rgba(255,45,120,0.4);
}
.clock-date {
  font-size: 0.9rem;
  color: var(--text-muted);
  letter-spacing: 0.3px;
}

/* CARD */
.card {
  background: var(--card-bg);
  border: 1px solid var(--card-border);
  border-radius: var(--radius);
  padding: 20px;
  backdrop-filter: blur(10px);
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}
.card-title {
  font-size: 0.75rem; font-weight: 700;
  text-transform: uppercase; letter-spacing: 1px;
  color: var(--text-muted); margin-bottom: 16px;
}

/* NAME INPUT */
.name-wrap { position: relative; }
.name-input {
  width: 100%; font-size: 1.2rem;
  padding: 14px 16px;
  border: 1.5px solid var(--card-border);
  border-radius: 12px;
  outline: none;
  transition: border-color .2s, box-shadow .2s;
  font-family: inherit;
  -webkit-appearance: none;
  background: rgba(255,255,255,0.05);
  color: var(--text);
}
.name-input::placeholder { color: var(--text-muted); }
.name-input:focus {
  border-color: var(--pink);
  box-shadow: 0 0 0 3px rgba(255,45,120,0.15), 0 0 15px rgba(255,45,120,0.2);
}
.name-input.has-value {
  border-color: var(--pink);
  background: rgba(255,45,120,0.05);
}

.suggest-box {
  position: absolute; top: calc(100% + 6px); left: 0; right: 0;
  background: #1a1a2e;
  border: 1px solid rgba(255,45,120,0.3);
  border-radius: 12px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.5), 0 0 20px rgba(255,45,120,0.1);
  z-index: 50; overflow: hidden; display: none;
  max-height: 200px; overflow-y: auto;
}
.suggest-item {
  padding: 13px 16px; cursor: pointer;
  font-size: 1rem; border-bottom: 1px solid rgba(255,255,255,0.06);
  transition: background .15s; color: var(--text);
}
.suggest-item:last-child { border-bottom: none; }
.suggest-item:hover, .suggest-item:active {
  background: rgba(255,45,120,0.15);
  color: var(--pink);
}
.suggest-item strong { color: var(--pink); }

.confirm-btn {
  width: 100%; margin-top: 12px; padding: 15px;
  font-size: 1.05rem; font-weight: 700;
  border: none; border-radius: 12px;
  background: linear-gradient(135deg, var(--pink), #c0006a);
  color: #fff;
  cursor: pointer; font-family: inherit;
  transition: opacity .2s, transform .1s, box-shadow .2s;
  box-shadow: 0 4px 15px rgba(255,45,120,0.4);
  letter-spacing: 0.3px;
}
.confirm-btn:active { transform: scale(.98); opacity: 0.9; }
.confirm-btn:disabled {
  background: rgba(255,255,255,0.08);
  color: var(--text-muted);
  box-shadow: none; cursor: not-allowed; transform: none;
}

/* STATUS CARD */
.status-card { border-radius: var(--radius); padding: 20px; display: none; }
.status-card.active {
  display: block;
  background: rgba(57,255,20,0.06);
  border: 1.5px solid rgba(57,255,20,0.3);
  box-shadow: 0 0 20px rgba(57,255,20,0.1);
}
.status-card.idle {
  display: block;
  background: var(--card-bg);
  border: 1px solid var(--card-border);
}

.status-header { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; }
.status-dot { width: 14px; height: 14px; border-radius: 50%; flex-shrink: 0; }
.status-dot.green {
  background: var(--green-neon);
  box-shadow: 0 0 0 3px rgba(57,255,20,0.2), 0 0 10px rgba(57,255,20,0.6);
  animation: pulse-green 2s infinite;
}
.status-dot.grey { background: rgba(255,255,255,0.2); }
@keyframes pulse-green {
  0%,100% { box-shadow: 0 0 0 3px rgba(57,255,20,0.2), 0 0 10px rgba(57,255,20,0.6); }
  50%      { box-shadow: 0 0 0 7px rgba(57,255,20,0.05), 0 0 20px rgba(57,255,20,0.3); }
}
.status-name { font-size: 1.15rem; font-weight: 700; flex: 1; }
.status-badge {
  font-size: 0.72rem; font-weight: 700;
  padding: 4px 10px; border-radius: 20px; letter-spacing: .4px;
}
.badge-in  { background: rgba(57,255,20,0.2); color: var(--green-neon); border: 1px solid rgba(57,255,20,0.4); }
.badge-out { background: rgba(255,45,120,0.2); color: var(--pink); border: 1px solid rgba(255,45,120,0.4); }
.badge-new { background: rgba(0,212,255,0.2); color: var(--blue); border: 1px solid rgba(0,212,255,0.4); }

.status-meta { font-size: 0.88rem; color: var(--text-muted); margin-bottom: 16px; }
.status-meta span { display: inline-block; margin-right: 12px; }
.status-meta strong { color: var(--text); }

.elapsed {
  font-size: 2.2rem; font-weight: 800;
  color: var(--green-neon);
  text-shadow: 0 0 15px rgba(57,255,20,0.6);
  font-variant-numeric: tabular-nums; margin-bottom: 2px;
}
.elapsed-label { font-size: 0.78rem; color: var(--text-muted); margin-bottom: 16px; letter-spacing: 0.5px; }

/* ACTION BUTTONS */
.action-row { display: flex; gap: 12px; }
.btn-checkin, .btn-checkout {
  flex: 1; padding: 20px 12px;
  font-size: 1.05rem; font-weight: 800;
  border: none; border-radius: 14px; cursor: pointer;
  font-family: inherit; display: flex;
  flex-direction: column; align-items: center; gap: 6px;
  transition: transform .1s, box-shadow .2s, opacity .2s;
}
.btn-checkin {
  background: linear-gradient(135deg, #00c853, #39ff14);
  color: #0a0a0f;
  box-shadow: 0 4px 20px rgba(57,255,20,0.4);
}
.btn-checkin:active { transform: scale(.97); box-shadow: none; }
.btn-checkin:disabled {
  background: rgba(255,255,255,0.07);
  color: var(--text-muted);
  box-shadow: none; cursor: not-allowed; transform: none;
}
.btn-checkout {
  background: linear-gradient(135deg, var(--pink), #c0006a);
  color: #fff;
  box-shadow: 0 4px 20px rgba(255,45,120,0.4);
}
.btn-checkout:active { transform: scale(.97); box-shadow: none; }
.btn-checkout:disabled {
  background: rgba(255,255,255,0.07);
  color: var(--text-muted);
  box-shadow: none; cursor: not-allowed; transform: none;
}
.btn-icon  { font-size: 1.6rem; line-height: 1; }
.btn-label { font-size: 0.68rem; opacity: .8; font-weight: 600; letter-spacing: 0.3px; }

/* LEADERBOARD */
.leaderboard-list { display: flex; flex-direction: column; gap: 10px; }
.lb-item {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 14px; border-radius: 12px;
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.08);
  transition: border-color 0.2s;
}
.lb-item.rank-1 {
  background: rgba(255,215,0,0.08);
  border-color: rgba(255,215,0,0.3);
  box-shadow: 0 0 12px rgba(255,215,0,0.1);
}
.lb-item.rank-2 {
  background: rgba(192,192,192,0.07);
  border-color: rgba(192,192,192,0.25);
}
.lb-item.rank-3 {
  background: rgba(205,127,50,0.08);
  border-color: rgba(205,127,50,0.3);
}

.lb-rank {
  width: 34px; height: 34px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.05rem; font-weight: 800; flex-shrink: 0;
}
.rank-1 .lb-rank { background: rgba(255,215,0,0.2); color: #FFD700; text-shadow: 0 0 8px rgba(255,215,0,0.6); }
.rank-2 .lb-rank { background: rgba(192,192,192,0.15); color: #C0C0C0; }
.rank-3 .lb-rank { background: rgba(205,127,50,0.2); color: #CD7F32; }
.rank-other .lb-rank { background: rgba(255,255,255,0.06); color: var(--text-muted); font-size: 0.85rem; }

.lb-name  { font-size: 0.98rem; font-weight: 600; flex: 1; }
.lb-hours { font-size: 0.82rem; color: var(--text-muted); text-align: right; line-height: 1.6; }
.lb-hours strong { display: block; font-size: 1rem; color: var(--pink); font-weight: 800; text-shadow: 0 0 8px rgba(255,45,120,0.4); }

.lb-empty { text-align: center; color: var(--text-muted); font-size: 0.9rem; padding: 20px 0; }

/* TODAY LOG */
.log-list  { display: flex; flex-direction: column; gap: 8px; }
.log-item  {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 12px; border-radius: 10px;
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.07);
  font-size: 0.88rem;
}
.log-name  { font-weight: 600; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.log-time  { color: var(--text-muted); white-space: nowrap; font-size: 0.82rem; }
.log-dur   { font-weight: 700; color: var(--pink); white-space: nowrap; text-shadow: 0 0 6px rgba(255,45,120,0.4); }
.log-badge { font-size: 0.7rem; font-weight: 700; padding: 2px 8px; border-radius: 12px; white-space: nowrap; }
.log-active { background: rgba(57,255,20,0.15); color: var(--green-neon); border: 1px solid rgba(57,255,20,0.3); }
.log-done   { background: rgba(255,45,120,0.15); color: var(--pink); border: 1px solid rgba(255,45,120,0.3); }
.log-empty  { text-align: center; color: var(--text-muted); font-size: 0.88rem; padding: 16px 0; }

/* CLOCK-OUT MODAL */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.7);
  backdrop-filter: blur(6px);
  z-index: 200; display: none;
  align-items: flex-end; justify-content: center;
}
.modal-overlay.show { display: flex; }
.modal-sheet {
  background: #12121f;
  border: 1px solid rgba(255,45,120,0.3);
  width: 100%; max-width: 560px;
  border-radius: 24px 24px 0 0;
  padding: 28px 24px 40px;
  transform: translateY(100%);
  transition: transform .3s cubic-bezier(.34,1.2,.64,1);
  box-shadow: 0 -10px 40px rgba(255,45,120,0.2);
}
.modal-overlay.show .modal-sheet { transform: translateY(0); }
.modal-handle { width: 40px; height: 4px; background: rgba(255,255,255,0.15); border-radius: 2px; margin: 0 auto 22px; }
.modal-title    { font-size: 1.2rem; font-weight: 800; margin-bottom: 16px; }
.modal-vol-info {
  background: rgba(255,45,120,0.08);
  border: 1px solid rgba(255,45,120,0.2);
  border-radius: 12px; padding: 14px 16px; margin-bottom: 16px;
}
.modal-vol-name { font-size: 1.1rem; font-weight: 700; color: var(--pink); margin-bottom: 4px; text-shadow: 0 0 10px rgba(255,45,120,0.4); }
.modal-elapsed  { font-size: 0.9rem; color: var(--text-muted); }
.modal-warning  {
  font-size: 0.85rem; color: #ffb347;
  background: rgba(255,179,71,0.1);
  border: 1px solid rgba(255,179,71,0.25);
  border-radius: 10px; padding: 10px 12px; margin-bottom: 20px;
}
.modal-actions  { display: flex; gap: 12px; }
.modal-cancel {
  flex: 1; padding: 16px; font-size: 1rem; font-weight: 700;
  border: 1px solid rgba(255,255,255,0.15); border-radius: 14px;
  background: rgba(255,255,255,0.05); color: var(--text);
  cursor: pointer; font-family: inherit; transition: background 0.2s;
}
.modal-cancel:hover { background: rgba(255,255,255,0.1); }
.modal-confirm {
  flex: 1; padding: 16px; font-size: 1rem; font-weight: 700;
  border: none; border-radius: 14px;
  background: linear-gradient(135deg, var(--pink), #c0006a);
  color: #fff; cursor: pointer; font-family: inherit;
  box-shadow: 0 4px 15px rgba(255,45,120,0.4);
}
.modal-confirm:hover { opacity: 0.9; }

/* TOAST */
.toast {
  position: fixed; bottom: 28px; left: 50%;
  transform: translateX(-50%) translateY(120px);
  background: rgba(20,20,35,0.95);
  border: 1px solid rgba(255,255,255,0.15);
  color: #fff;
  padding: 12px 24px; border-radius: 30px;
  font-size: 0.92rem; font-weight: 600;
  white-space: nowrap; z-index: 999;
  transition: transform .4s cubic-bezier(.34,1.56,.64,1), opacity .3s;
  opacity: 0; box-shadow: 0 8px 30px rgba(0,0,0,0.4);
  backdrop-filter: blur(12px);
}
.toast.show    { transform: translateX(-50%) translateY(0); opacity: 1; }
.toast.success { background: rgba(0,150,60,0.9); border-color: rgba(57,255,20,0.4); box-shadow: 0 0 20px rgba(57,255,20,0.3); }
.toast.error   { background: rgba(180,0,50,0.9); border-color: rgba(255,45,120,0.4); box-shadow: 0 0 20px rgba(255,45,120,0.3); }

@media (max-width: 400px) {
  .clock-display { font-size: 2.8rem; letter-spacing: 3px; }
  .btn-checkin, .btn-checkout { padding: 16px 8px; }
}
</style>
</head>
<body>

<nav>
  <a href="index.html" class="back-btn">‚Üê ËøîÂõû‰∏ªÈ†Å</a>
  <div class="logo">SHK <span>Áæ©Â∑•Á∞ΩÂà∞</span></div>
  <div class="nav-time" id="nav-time"></div>
</nav>

<div class="page">

  <!-- 1. Clock Hero -->
  <div class="clock-hero">
    <div class="clock-display" id="clock">00:00:00</div>
    <div class="clock-date"   id="clock-date"></div>
  </div>

  <!-- 2. Name Search -->
  <div class="card">
    <div class="card-title">Áæ©Â∑•ÂßìÂêç</div>
    <div class="name-wrap">
      <input
        id="name-input"
        class="name-input"
        type="text"
        placeholder="Ëº∏ÂÖ•ÂßìÂêçÊêúÂ∞ã..."
        autocomplete="off"
        autocorrect="off"
        spellcheck="false"
        oninput="onNameInput()"
        onkeydown="onNameKey(event)"
      >
      <div class="suggest-box" id="suggest-box"></div>
    </div>
    <button class="confirm-btn" id="confirm-btn" onclick="lookupVolunteer()" disabled>
      Á¢∫Ë™çË∫´‰ªΩ
    </button>
  </div>

  <!-- 3. Status + Actions -->
  <div class="status-card" id="status-card">
    <div class="status-header">
      <div class="status-dot"  id="status-dot"></div>
      <div class="status-name" id="status-name"></div>
      <div class="status-badge" id="status-badge"></div>
    </div>
    <div class="status-meta" id="status-meta"></div>
    <div class="elapsed"       id="elapsed"       style="display:none"></div>
    <div class="elapsed-label" id="elapsed-label" style="display:none">Â∑≤ÊúçÂãôÊôÇÈñì</div>
    <div class="action-row">
      <button class="btn-checkin"  id="btn-in"  onclick="clockIn()">
        <span class="btn-icon">‚ñ∂</span>
        <span>Clock In</span>
        <span class="btn-label">ÈñãÂßãÊúçÂãô</span>
      </button>
      <button class="btn-checkout" id="btn-out" onclick="showClockOutModal()">
        <span class="btn-icon">‚ñ†</span>
        <span>Clock Out</span>
        <span class="btn-label">ÂÆåÊàêÊúçÂãô</span>
      </button>
    </div>
  </div>

  <!-- 4. Monthly Leaderboard -->
  <div class="card">
    <div class="card-title">üèÜ Êú¨ÊúàÁæ©Â∑•ÊôÇÊï∏ÊéíË°åÊ¶ú</div>
    <div class="leaderboard-list" id="leaderboard"></div>
  </div>

  <!-- 5. Today Log -->
  <div class="card">
    <div class="card-title">‰ªäÊó•Á∞ΩÂà∞Ë®òÈåÑ</div>
    <div class="log-list" id="today-log"></div>
  </div>

</div>

<!-- Clock-Out Confirmation Modal -->
<div class="modal-overlay" id="modal-overlay" onclick="onOverlayClick(event)">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">Á¢∫Ë™ç Clock OutÔºü</div>
    <div class="modal-vol-info">
      <div class="modal-vol-name" id="modal-vol-name"></div>
      <div class="modal-elapsed"  id="modal-elapsed"></div>
    </div>
    <div class="modal-warning">‚ö†Ô∏è Clock Out ÂæåÂ∞áË®òÈåÑÊúçÂãôÊôÇÊï∏ÔºåË´ãÁ¢∫Ë™çÁÑ°Ë™§„ÄÇ</div>
    <div class="modal-actions">
      <button class="modal-cancel"  onclick="closeModal()">ÂèñÊ∂à</button>
      <button class="modal-confirm" onclick="confirmClockOut()">Á¢∫Ë™ç Clock Out</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ KEYS ‚îÄ‚îÄ
const LOGS_KEY  = 'shk_vol_logs';
const NAMES_KEY = 'shk_vol_names';

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let currentName  = '';
let currentLog   = null;
let elapsedTimer = null;

// ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ
function updateClock() {
  const n  = new Date();
  const hh = String(n.getHours()).padStart(2,'0');
  const mm = String(n.getMinutes()).padStart(2,'0');
  const ss = String(n.getSeconds()).padStart(2,'0');
  document.getElementById('clock').textContent     = `${hh}:${mm}:${ss}`;
  document.getElementById('nav-time').textContent  = `${hh}:${mm}`;
  document.getElementById('clock-date').textContent =
    n.toLocaleDateString('zh-HK', {year:'numeric', month:'long', day:'numeric', weekday:'short'});
}
setInterval(updateClock, 1000);
updateClock();

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function getLogs()  { try { return JSON.parse(localStorage.getItem(LOGS_KEY) ||'[]'); } catch(e){return[];} }
function saveLogs(a){ localStorage.setItem(LOGS_KEY,  JSON.stringify(a)); }
function getNames() { try { return JSON.parse(localStorage.getItem(NAMES_KEY)||'[]'); } catch(e){return[];} }
function addName(n) {
  let arr = getNames().filter(x => x.toLowerCase() !== n.toLowerCase());
  arr.unshift(n);
  if (arr.length > 200) arr = arr.slice(0, 200);
  localStorage.setItem(NAMES_KEY, JSON.stringify(arr));
}
function todayStr() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function fmtTime(ms) {
  const d = new Date(ms);
  return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
}
function fmtDur(mins) {
  if (mins == null) return '--';
  const h = Math.floor(mins / 60), m = mins % 60;
  return h > 0 ? `${h}h ${m}m` : `${m}m`;
}

// ‚îÄ‚îÄ NAME INPUT ‚îÄ‚îÄ
function onNameInput() {
  const val = document.getElementById('name-input').value.trim();
  document.getElementById('confirm-btn').disabled = val.length === 0;
  document.getElementById('name-input').classList.toggle('has-value', val.length > 0);
  renderSuggest(val);
}

function renderSuggest(val) {
  const box = document.getElementById('suggest-box');
  if (!val) { box.style.display = 'none'; return; }
  const matches = getNames()
    .filter(n => n.toLowerCase().includes(val.toLowerCase()))
    .slice(0, 8);
  if (!matches.length) { box.style.display = 'none'; return; }
  const esc = val.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  box.innerHTML = matches.map(n =>
    `<div class="suggest-item" onmousedown="selectName('${n.replace(/'/g,"\\'")}')">
      ${n.replace(new RegExp('('+esc+')','gi'),'<strong>$1</strong>')}
    </div>`
  ).join('');
  box.style.display = 'block';
}

function selectName(name) {
  document.getElementById('name-input').value = name;
  document.getElementById('suggest-box').style.display = 'none';
  document.getElementById('name-input').classList.add('has-value');
  document.getElementById('confirm-btn').disabled = false;
  lookupVolunteer();
}

function onNameKey(e) {
  if (e.key === 'Enter')  { lookupVolunteer(); document.getElementById('suggest-box').style.display='none'; }
  if (e.key === 'Escape') { document.getElementById('suggest-box').style.display='none'; }
}

document.addEventListener('click', e => {
  if (!e.target.closest('.name-wrap'))
    document.getElementById('suggest-box').style.display = 'none';
});

// ‚îÄ‚îÄ LOOKUP ‚îÄ‚îÄ
function lookupVolunteer() {
  const name = document.getElementById('name-input').value.trim();
  if (!name) return;
  currentName = name;
  document.getElementById('suggest-box').style.display = 'none';

  const logs       = getLogs();
  const todayLogs  = logs.filter(l => l.name.toLowerCase() === name.toLowerCase() && l.date === todayStr());
  const inProgress = todayLogs.find(l => !l.outMs);

  renderStatusCard(name, inProgress, todayLogs);
  renderTodayLog();
  renderLeaderboard();
}

// ‚îÄ‚îÄ STATUS CARD ‚îÄ‚îÄ
function renderStatusCard(name, inProgress, todayLogs) {
  const card   = document.getElementById('status-card');
  const dot    = document.getElementById('status-dot');
  const sname  = document.getElementById('status-name');
  const badge  = document.getElementById('status-badge');
  const meta   = document.getElementById('status-meta');
  const elDiv  = document.getElementById('elapsed');
  const elLbl  = document.getElementById('elapsed-label');
  const btnIn  = document.getElementById('btn-in');
  const btnOut = document.getElementById('btn-out');

  card.className = 'status-card';
  sname.textContent = name;
  clearInterval(elapsedTimer);
  elDiv.style.display = 'none';
  elLbl.style.display = 'none';

  if (inProgress) {
    currentLog = inProgress;
    card.classList.add('active');
    dot.className  = 'status-dot green';
    badge.textContent = 'ÊúçÂãô‰∏≠';
    badge.className   = 'status-badge badge-in';
    meta.innerHTML    = `<span>Clock In: <strong>${inProgress.inTime}</strong></span>`;
    elDiv.style.display = 'block';
    elLbl.style.display = 'block';

    const tick = () => {
      const mins = Math.floor((Date.now() - inProgress.inMs) / 60000);
      elDiv.textContent = fmtDur(mins);
    };
    tick();
    elapsedTimer = setInterval(tick, 10000);

    btnIn.disabled  = true;
    btnOut.disabled = false;

  } else if (todayLogs.length > 0) {
    currentLog = null;
    const totalMins = todayLogs.reduce((s,l) => s + (l.durMin||0), 0);
    card.classList.add('idle');
    dot.className     = 'status-dot grey';
    badge.textContent = 'Â∑≤ÂÆåÊàê';
    badge.className   = 'status-badge badge-out';
    meta.innerHTML    = `<span>‰ªäÊó•ÂÖ±ÊúçÂãô: <strong>${fmtDur(totalMins)}</strong></span><span>${todayLogs.length} ÁØÄ</span>`;
    btnIn.disabled  = false;
    btnOut.disabled = true;

  } else {
    currentLog = null;
    card.classList.add('idle');
    dot.className     = 'status-dot grey';
    badge.textContent = '‰ªäÊó•Êú™Á∞ΩÂà∞';
    badge.className   = 'status-badge badge-new';
    meta.textContent  = 'Êåâ Clock In ÈñãÂßãË®òÈåÑÊúçÂãôÊôÇÈñì';
    btnIn.disabled  = false;
    btnOut.disabled = true;
  }
}

// ‚îÄ‚îÄ CLOCK IN ‚îÄ‚îÄ
function clockIn() {
  if (!currentName) return;
  const now = Date.now();
  const log = {
    id: 'ci' + now, name: currentName,
    date: todayStr(), inTime: fmtTime(now), inMs: now,
    outTime: null, outMs: null, durMin: null
  };
  const logs = getLogs();
  logs.push(log);
  saveLogs(logs);
  addName(currentName);

  fetch('https://formspree.io/hkerssalford@gmail.com', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
    body: JSON.stringify({
      _subject: `„ÄêSHK Áæ©Â∑•Á∞ΩÂà∞„Äë${currentName} Clock In - ${todayStr()}`,
      ÂßìÂêç: currentName, Êó•Êúü: todayStr(),
      Á∞ΩÂà∞ÊôÇÈñì: fmtTime(now), Á∞ΩÂá∫ÊôÇÈñì: 'ÔºàÊúçÂãô‰∏≠Ôºâ', Á∏ΩÊôÇÈï∑: '--'
    })
  }).catch(() => {});

  showToast(`${currentName} Clock In ÊàêÂäüÔºÅ`, 'success');
  lookupVolunteer();
}

// ‚îÄ‚îÄ CLOCK OUT MODAL ‚îÄ‚îÄ
function showClockOutModal() {
  if (!currentLog) return;
  const mins = Math.floor((Date.now() - currentLog.inMs) / 60000);
  document.getElementById('modal-vol-name').textContent = currentLog.name;
  document.getElementById('modal-elapsed').textContent  = `Â∑≤ÊúçÂãôÊôÇÈñìÔºö${fmtDur(mins)}Ôºà${currentLog.inTime} ÈñãÂßãÔºâ`;
  document.getElementById('modal-overlay').classList.add('show');
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('show');
}

function onOverlayClick(e) {
  if (e.target === document.getElementById('modal-overlay')) closeModal();
}

function confirmClockOut() {
  closeModal();
  if (!currentLog) return;
  const now  = Date.now();
  const mins = Math.floor((now - currentLog.inMs) / 60000);
  const logs = getLogs();
  const idx  = logs.findIndex(l => l.id === currentLog.id);
  if (idx !== -1) {
    logs[idx].outTime = fmtTime(now);
    logs[idx].outMs   = now;
    logs[idx].durMin  = mins;
    saveLogs(logs);
  }
  clearInterval(elapsedTimer);
  const outName = currentLog ? currentLog.name : currentName;
  const inTime  = currentLog ? currentLog.inTime : '--';
  currentLog = null;

  fetch('https://formspree.io/hkerssalford@gmail.com', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
    body: JSON.stringify({
      _subject: `„ÄêSHK Áæ©Â∑•Á∞ΩÂà∞„Äë${outName} Clock Out - ${todayStr()}`,
      ÂßìÂêç: outName, Êó•Êúü: todayStr(),
      Á∞ΩÂà∞ÊôÇÈñì: inTime, Á∞ΩÂá∫ÊôÇÈñì: fmtTime(now), Á∏ΩÊôÇÈï∑: fmtDur(mins)
    })
  }).catch(() => {});

  showToast(`Clock Out ÂÆåÊàêÔºÅÂÖ±ÊúçÂãô ${fmtDur(mins)}`, 'success');
  lookupVolunteer();
}

// ‚îÄ‚îÄ LEADERBOARD ‚îÄ‚îÄ
function renderLeaderboard() {
  const now  = new Date();
  const ym   = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const logs = getLogs().filter(l => l.date && l.date.startsWith(ym) && l.durMin != null);

  const map = {};
  logs.forEach(l => {
    const key = l.name.trim();
    if (!map[key]) map[key] = { mins: 0, sessions: 0, days: new Set() };
    map[key].mins     += l.durMin;
    map[key].sessions += 1;
    map[key].days.add(l.date);
  });

  const sorted = Object.entries(map)
    .map(([name, v]) => ({ name, mins: v.mins, sessions: v.sessions, days: v.days.size }))
    .sort((a, b) => b.mins - a.mins)
    .slice(0, 5);

  const el     = document.getElementById('leaderboard');
  const month  = now.toLocaleDateString('zh-HK', { month: 'long' });
  const medals = ['ü•á', 'ü•à', 'ü•â'];

  if (!sorted.length) {
    el.innerHTML = `<div class="lb-empty">${month}Êö´ÁÑ°ÂÆåÊàêË®òÈåÑ</div>`;
    return;
  }

  el.innerHTML = sorted.map((v, i) => {
    const cls  = i < 3 ? `rank-${i+1}` : 'rank-other';
    const icon = i < 3 ? medals[i] : `${i+1}`;
    const hrs  = (v.mins / 60).toFixed(1);
    return `
      <div class="lb-item ${cls}">
        <div class="lb-rank">${icon}</div>
        <div class="lb-name">${v.name}</div>
        <div class="lb-hours">
          <strong>${hrs} Â∞èÊôÇ</strong>
          ${v.sessions} ÁØÄ ¬∑ ${v.days} Êó•
        </div>
      </div>`;
  }).join('');
}

// ‚îÄ‚îÄ TODAY LOG ‚îÄ‚îÄ
function renderTodayLog() {
  const logs = getLogs().filter(l => l.date === todayStr()).reverse();
  const el   = document.getElementById('today-log');

  if (!logs.length) {
    el.innerHTML = '<div class="log-empty">‰ªäÊó•Êö´ÁÑ°Ë®òÈåÑ</div>';
    return;
  }

  el.innerHTML = logs.map(l => {
    const active = !l.outMs;
    const dur    = active
      ? `<span class="log-badge log-active">ÊúçÂãô‰∏≠</span>`
      : `<span class="log-dur">${fmtDur(l.durMin)}</span>`;
    const times  = active ? `${l.inTime} ‚Üí` : `${l.inTime} ‚Äì ${l.outTime}`;
    return `
      <div class="log-item">
        <div class="log-name">${l.name}</div>
        <div class="log-time">${times}</div>
        ${dur}
      </div>`;
  }).join('');
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function showToast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className   = `toast show ${type}`;
  clearTimeout(t._t);
  t._t = setTimeout(() => { t.className = 'toast'; }, 3200);
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
renderLeaderboard();
renderTodayLog();
document.getElementById('name-input').focus();
</script>
</body>
</html>
